
[1m[46m RUN [49m[22m [36mv4.0.18 [39m[90mC:/Users/shuga/1kittroot/1code/Angular-build[39m

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2minitialize[2m > [22m[2mshould initialize indexes via createFtsIndexes
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mtrue[39m, notesFts: [33mtrue[39m, notesContentFts: [33mtrue[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2minitialize[2m > [22m[2mshould be idempotent
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mtrue[39m, notesFts: [33mtrue[39m, notesContentFts: [33mtrue[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2msearchBlocks[2m > [22m[2mshould use FTS query when index is available
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mtrue[39m, notesFts: [33mtrue[39m, notesContentFts: [33mtrue[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2msearchBlocks[2m > [22m[2mshould fallback to Regex when FTS index is missing
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mfalse[39m, notesFts: [33mfalse[39m, notesContentFts: [33mfalse[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2msearchBlocks[2m > [22m[2mshould fallback to Regex when FTS returns no results
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mtrue[39m, notesFts: [33mtrue[39m, notesContentFts: [33mtrue[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2msearchNotes[2m > [22m[2mshould use Combined FTS when both indexes available
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mtrue[39m, notesFts: [33mtrue[39m, notesContentFts: [33mtrue[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2msearchNotes[2m > [22m[2mshould fallback to Regex if FTS disabled
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mfalse[39m, notesFts: [33mfalse[39m, notesContentFts: [33mfalse[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2mhybridSearch[2m > [22m[2mshould return empty if FTS not available
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mfalse[39m, notesFts: [33mfalse[39m, notesContentFts: [33mfalse[39m }

[90mstdout[2m | src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22m[2mFtsService[2m > [22m[2mhybridSearch[2m > [22m[2mshould run hybrid query if FTS available
[22m[39m[FtsService] FTS indexes initialized: { blocksFts: [33mtrue[39m, notesFts: [33mtrue[39m, notesContentFts: [33mtrue[39m }

 [32mΓ£ô[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22minitialize[2m > [22mshould initialize indexes via createFtsIndexes[32m 5[2mms[22m[39m
 [32mΓ£ô[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22minitialize[2m > [22mshould be idempotent[32m 1[2mms[22m[39m
 [31m├ù[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22msearchBlocks[2m > [22mshould use FTS query when index is available[32m 15[2mms[22m[39m
[31m   ΓåÆ expected "vi.fn()" to be called with arguments: [ StringContaining "::fts", ΓÇª(1) ][90m

Received: 

[1m  1st vi.fn() call:

[22m[2m  [[22m
[32m-   StringContaining "::fts",[90m
[32m-   ObjectContaining {[90m
[31m+   "[90m
[31m+         ?[block_id, note_id, text, score] :=[90m
[31m+             ~blocks:blocks_fts {block_id, text |[90m
[31m+                 query: $query,[90m
[31m+                 min_score: $min_score,[90m
[31m+                 k: $k[90m
[31m+             },[90m
[31m+             *blocks{block_id, note_id, text}[90m
[31m+         :order -score[90m
[31m+         :limit $limit[90m
[31m+     ",[90m
[31m+   {[90m
[31m+     "k": 20,[90m
[31m+     "limit": 50,[90m
[31m+     "min_score": 0.3,[90m
[31m+     "narrative_id": "",[90m
[2m      "query": "test",[22m
[2m    },[22m
[2m  ][22m

[1m  2nd vi.fn() call:

[22m[2m  [[22m
[32m-   StringContaining "::fts",[90m
[32m-   ObjectContaining {[90m
[31m+   "[90m
[31m+         ?[scope_id, note_id, ts, action_type, target_id, target_kind, payload, narrative_id] <- [90m
[31m+             [[$scope_id, $note_id, $ts, $action_type, $target_id, $target_kind, $payload, $narrative_id]][90m
[31m+         :put episode_log {[90m
[31m+             scope_id, note_id, ts => action_type, target_id, target_kind, payload, narrative_id[90m
[31m+         }[90m
[31m+     ",[90m
[31m+   {[90m
[31m+     "action_type": "fts_search",[90m
[31m+     "narrative_id": "",[90m
[31m+     "note_id": "",[90m
[31m+     "payload": {[90m
[31m+       "metadata": {[90m
[31m+         "latMs": 0,[90m
[2m          "query": "test",[22m
[31m+         "resultCount": 1,[90m
[31m+         "scopeMode": "global",[90m
[31m+         "target": "blocks",[90m
[31m+       },[90m
[31m+     },[90m
[31m+     "scope_id": "system",[90m
[31m+     "target_id": "test",[90m
[31m+     "target_kind": "search",[90m
[31m+     "ts": 1771041803017,[90m
[2m    },[22m
[2m  ][22m
[31m[90m

Number of calls: [1m2[22m
[31m[39m
 [31m├ù[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22msearchBlocks[2m > [22mshould fallback to Regex when FTS index is missing[32m 2[2mms[22m[39m
[31m   ΓåÆ expected "vi.fn()" to be called with arguments: [ StringContaining "~blocks", ΓÇª(1) ][90m

Received: 

[1m  1st vi.fn() call:

[22m[2m  [[22m
[32m-   StringContaining "~blocks",[90m
[32m-   ObjectContaining {[90m
[31m+   "[90m
[31m+         ?[block_id, note_id, text] :=[90m
[31m+             *blocks{block_id, note_id, text},[90m
[31m+             text ~ $pattern[90m
[31m+         :limit $limit[90m
[31m+     ",[90m
[31m+   {[90m
[31m+     "limit": 50,[90m
[2m      "pattern": "(?i)test",[22m
[2m    },[22m
[2m  ][22m

[1m  2nd vi.fn() call:

[22m[2m  [[22m
[32m-   StringContaining "~blocks",[90m
[32m-   ObjectContaining {[90m
[32m-     "pattern": "(?i)test",[90m
[31m+   "[90m
[31m+         ?[scope_id, note_id, ts, action_type, target_id, target_kind, payload, narrative_id] <- [90m
[31m+             [[$scope_id, $note_id, $ts, $action_type, $target_id, $target_kind, $payload, $narrative_id]][90m
[31m+         :put episode_log {[90m
[31m+             scope_id, note_id, ts => action_type, target_id, target_kind, payload, narrative_id[90m
[31m+         }[90m
[31m+     ",[90m
[31m+   {[90m
[31m+     "action_type": "fts_search",[90m
[31m+     "narrative_id": "",[90m
[31m+     "note_id": "",[90m
[31m+     "payload": {[90m
[31m+       "metadata": {[90m
[31m+         "latMs": 1,[90m
[31m+         "query": "test",[90m
[31m+         "resultCount": 1,[90m
[31m+         "scopeMode": "global",[90m
[31m+         "target": "blocks",[90m
[31m+       },[90m
[31m+     },[90m
[31m+     "scope_id": "system",[90m
[31m+     "target_id": "test",[90m
[31m+     "target_kind": "search",[90m
[31m+     "ts": 1771041803033,[90m
[2m    },[22m
[2m  ][22m
[31m[90m

Number of calls: [1m2[22m
[31m[39m
 [31m├ù[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22msearchBlocks[2m > [22mshould fallback to Regex when FTS returns no results[32m 2[2mms[22m[39m
[31m   ΓåÆ expected "vi.fn()" to be called 2 times, but got 3 times[39m
 [32mΓ£ô[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22msearchNotes[2m > [22mshould use Combined FTS when both indexes available[32m 2[2mms[22m[39m
 [32mΓ£ô[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22msearchNotes[2m > [22mshould fallback to Regex if FTS disabled[32m 2[2mms[22m[39m
 [32mΓ£ô[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22mhybridSearch[2m > [22mshould return empty if FTS not available[32m 1[2mms[22m[39m
 [32mΓ£ô[39m src/app/lib/cozo/fts/FtsService.spec.ts[2m > [22mFtsService[2m > [22mhybridSearch[2m > [22mshould run hybrid query if FTS available[32m 2[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (9)[39m
[2m   Start at [22m 23:03:22
[2m   Duration [22m 781ms[2m (transform 175ms, setup 0ms, import 542ms, tests 37ms, environment 0ms)[22m

