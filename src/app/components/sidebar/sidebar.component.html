<!-- Two-Rail Sidebar: Icon Rail (always visible) + Content Panel (collapsible) -->
<div class="flex h-full">
    <!-- ═══════════════════════════════════════════════════════════════════════════ 
         ICON RAIL (Always Visible)
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="w-12 h-full flex flex-col border-r border-sidebar-border bg-sidebar shrink-0">
        <!-- Top Section: New Note -->
        <div
            class="h-10 flex items-center justify-center border-b border-white/10 bg-gradient-to-b from-zinc-800 to-zinc-950">
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-white/10 text-white/80 hover:text-white transition-colors"
                title="New Note" (click)="createNote()">
                <lucide-icon [img]="Plus" size="18"></lucide-icon>
            </button>
        </div>

        <!-- Main Navigation Icons -->
        <div class="flex-1 flex flex-col items-center py-3 gap-1.5 overflow-y-auto">
            <!-- Files -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md transition-all duration-200 relative group"
                [class.bg-primary/10]="viewMode() === 'files'" [class.text-primary]="viewMode() === 'files'"
                [class.text-muted-foreground]="viewMode() !== 'files'"
                [class.hover:text-foreground]="viewMode() !== 'files'"
                [class.hover:bg-muted/10]="viewMode() !== 'files'" title="Files" (click)="setViewMode('files')">
                <div *ngIf="viewMode() === 'files'"
                    class="absolute left-0 top-1/2 -translate-y-1/2 w-0.5 h-4 bg-primary rounded-r-full"></div>
                <lucide-icon [img]="FileText" size="18"></lucide-icon>
            </button>

            <!-- Narrative -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md text-purple-500 hover:text-purple-400 hover:bg-purple-500/10 transition-all duration-200"
                title="Create Narrative Vault" (click)="createNarrative()">
                <lucide-icon [img]="BookOpen" size="18"></lucide-icon>
            </button>

            <!-- Calendar -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md text-emerald-500 hover:text-emerald-400 hover:bg-emerald-500/10 transition-all duration-200"
                title="Fantasy Calendar" (click)="navigateToCalendar()">
                <lucide-icon [img]="Calendar" size="18"></lucide-icon>
            </button>

            <!-- 3D Graph -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md text-cyan-500 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all duration-200"
                title="Knowledge Graph" (click)="navigateToGraph()">
                <lucide-icon [img]="Share2" size="18"></lucide-icon>
            </button>

            <!-- Search -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md transition-all duration-200 relative group"
                [class.bg-primary/10]="viewMode() === 'search'" [class.text-primary]="viewMode() === 'search'"
                [class.text-muted-foreground]="viewMode() !== 'search'"
                [class.hover:text-foreground]="viewMode() !== 'search'"
                [class.hover:bg-muted/10]="viewMode() !== 'search'" title="Semantic Search"
                (click)="setViewMode('search')">
                <div *ngIf="viewMode() === 'search'"
                    class="absolute left-0 top-1/2 -translate-y-1/2 w-0.5 h-4 bg-primary rounded-r-full"></div>
                <lucide-icon [img]="Search" size="18"></lucide-icon>
            </button>

            <!-- NER -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-md transition-all duration-200 relative group"
                [class.bg-primary/10]="viewMode() === 'ner'" [class.text-primary]="viewMode() === 'ner'"
                [class.text-muted-foreground]="viewMode() !== 'ner'"
                [class.hover:text-foreground]="viewMode() !== 'ner'" [class.hover:bg-muted/10]="viewMode() !== 'ner'"
                title="Entity Detection" (click)="toggleNer()">
                <div *ngIf="viewMode() === 'ner'"
                    class="absolute left-0 top-1/2 -translate-y-1/2 w-0.5 h-4 bg-primary rounded-r-full"></div>
                <lucide-icon [img]="Brain" size="18"></lucide-icon>
            </button>
        </div>

        <!-- Bottom Section: Collapse Toggle -->
        <div class="h-8 flex items-center justify-center border-t border-sidebar-border bg-[hsl(var(--sidebar-bg))]">
            <button
                class="w-6 h-6 flex items-center justify-center rounded-md text-muted-foreground hover:text-foreground hover:bg-muted/20 transition-colors"
                [title]="sidebarService.isOpen() ? 'Collapse Panel' : 'Expand Panel'"
                (click)="sidebarService.toggleCollapse()">
                <lucide-icon [img]="sidebarService.isOpen() ? PanelLeftClose : PanelLeft" size="14"></lucide-icon>
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════ 
         CONTENT PANEL (Collapsible)
         ═══════════════════════════════════════════════════════════════════════════ -->
    <aside
        class="h-full border-r border-sidebar-border bg-sidebar text-sidebar-foreground flex flex-col transition-all duration-300 ease-in-out overflow-hidden"
        [class.w-60]="sidebarService.isOpen()" [class.w-0]="!sidebarService.isOpen()">

        <!-- Panel Header -->
        <div
            class="h-10 flex items-center justify-between px-3 border-b border-white/10 shrink-0 bg-gradient-to-b from-zinc-800 to-zinc-950 text-slate-200">
            <span class="text-sm font-semibold text-slate-200">
                <ng-container [ngSwitch]="viewMode()">
                    <span *ngSwitchCase="'files'">Folders</span>
                    <span *ngSwitchCase="'search'">Search</span>
                    <span *ngSwitchCase="'ner'">Entities</span>
                </ng-container>
            </span>

            <!-- Header Actions -->
            <div class="flex items-center gap-1">
                <!-- Global Tools -->
                <button class="p-1.5 text-white/80 hover:text-white rounded-md hover:bg-white/10 transition-colors"
                    (click)="editorService.undo()" title="Undo">
                    <lucide-icon [img]="Undo" size="14"></lucide-icon>
                </button>
                <button class="p-1.5 text-white/80 hover:text-white rounded-md hover:bg-white/10 transition-colors"
                    (click)="editorService.redo()" title="Redo">
                    <lucide-icon [img]="Redo" size="14"></lucide-icon>
                </button>
                <button class="p-1.5 text-white/80 hover:text-white rounded-md hover:bg-white/10 transition-colors"
                    (click)="themeService.toggleTheme($event)"
                    [title]="themeService.isDark() ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
                    <lucide-icon [img]="themeService.isDark() ? Sun : Moon" size="14"></lucide-icon>
                </button>

                <!-- Divider -->
                <div class="w-px h-3 bg-white/20 mx-1"></div>

                <!-- Reorder Mode Toggle (only for files view) -->
                <button *ngIf="viewMode() === 'files'" class="p-1.5 rounded-md transition-colors"
                    [class.bg-amber-500/20]="reorderService.isReorderMode()"
                    [class.text-amber-300]="reorderService.isReorderMode()"
                    [class.text-white/80]="!reorderService.isReorderMode()"
                    [class.hover:text-white]="!reorderService.isReorderMode()"
                    [class.hover:bg-white/10]="!reorderService.isReorderMode()"
                    [title]="reorderService.isReorderMode() ? 'Exit Reorder Mode' : 'Enter Reorder Mode'"
                    (click)="toggleReorderMode()">
                    <lucide-icon [img]="MoveVertical" size="14"></lucide-icon>
                </button>

                <!-- Folder Actions (only for files view) -->
                <div *ngIf="viewMode() === 'files'" class="relative">
                    <button class="p-1.5 rounded-md hover:bg-white/10 text-white/80 hover:text-white transition-colors"
                        title="New Folder" (click)="toggleFolderDropdown()">
                        <lucide-icon [img]="FolderPlus" size="14"></lucide-icon>
                    </button>

                    <!-- Folder Dropdown Menu -->
                    <div *ngIf="folderDropdownOpen()"
                        class="absolute top-full right-0 mt-1 z-[1000] min-w-56 bg-popover border border-border rounded-lg shadow-xl py-1 text-sm">

                        <!-- Entity Folders Header -->
                        <div class="px-3 py-1.5 text-xs font-medium text-muted-foreground uppercase tracking-wide">
                            Entity Folders
                        </div>

                        <!-- Entity Folder Options -->
                        <button *ngFor="let option of entityFolderOptions" class="folder-menu-item"
                            (click)="createEntityFolder(option)">
                            <lucide-icon [img]="option.icon" size="14" [style.color]="option.color"></lucide-icon>
                            <span class="flex-1">{{ option.label }}</span>
                            <span class="text-[10px] font-medium px-1.5 py-0.5 rounded"
                                [style.background-color]="option.color" [style.color]="'white'">
                                {{ option.entityKind }}
                            </span>
                        </button>

                        <!-- Divider -->
                        <div class="h-px bg-border my-1"></div>

                        <!-- Regular Folder -->
                        <button class="folder-menu-item" (click)="createRegularFolder()">
                            <lucide-icon [img]="Folder" size="14" class="text-muted-foreground"></lucide-icon>
                            <span class="flex-1">Regular Folder</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backdrop to close dropdown -->
        <div *ngIf="folderDropdownOpen()" class="fixed inset-0 z-40" (click)="closeFolderDropdown()">
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-hidden">
            <!-- File Tree -->
            <app-file-tree *ngIf="viewMode() === 'files'" [tree]="treeData()"></app-file-tree>

            <!-- Search Panel -->
            <app-search-panel *ngIf="viewMode() === 'search'"></app-search-panel>

            <!-- NER Panel -->
            <app-ner-panel *ngIf="viewMode() === 'ner'"></app-ner-panel>
        </div>

        <!-- Panel Footer -->
        <div
            class="h-8 flex items-center justify-between px-3 border-t border-border shrink-0 text-xs font-medium tracking-wide bg-gradient-to-b from-white to-gray-50 dark:from-zinc-900 dark:to-zinc-950 text-slate-600 dark:text-slate-400 relative z-10">
            <span>{{ treeData().length }} items</span>

            <!-- Graph Scan Button -->
            <button (click)="triggerGraphScan()" [disabled]="isScanning()"
                class="flex items-center gap-1.5 px-2 py-1 rounded-md transition-colors"
                [class.bg-teal-500/10]="!isScanning()" [class.text-teal-700]="!isScanning()"
                [class.hover:bg-teal-500/20]="!isScanning()" [class.bg-amber-500/10]="isScanning()"
                [class.text-amber-700]="isScanning()" [class.cursor-wait]="isScanning()"
                [title]="isScanning() ? 'Scanning...' : 'Run Graph Scan on Current Note'">
                <lucide-icon [img]="RefreshCw" size="12" [class.animate-spin]="isScanning()">
                </lucide-icon>
                <span class="text-[10px] font-medium">{{ isScanning() ? 'Scanning...' : 'Graph Scan' }}</span>
            </button>
        </div>
    </aside>
</div>