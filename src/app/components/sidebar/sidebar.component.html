<!-- Sidebar Shell -->
<aside
    class="h-full border-r border-border bg-sidebar flex flex-col transition-all duration-300 ease-in-out overflow-hidden"
    [class.w-64]="sidebarService.isOpen()" [class.w-0]="!sidebarService.isOpen()">

    <!-- Sidebar Header with Action Buttons -->
    <div class="h-10 flex items-center justify-between px-3 border-b border-border shrink-0">
        <span class="text-sm font-semibold text-foreground">Navigator</span>

        <!-- Quick Action Buttons -->
        <div class="flex items-center gap-1">
            <!-- New Note Button -->
            <button
                class="p-1.5 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground transition-colors"
                title="New Note" (click)="createNote()">
                <lucide-icon [img]="Plus" size="16"></lucide-icon>
            </button>

            <!-- Folder Dropdown Trigger -->
            <div class="relative">
                <button
                    class="p-1.5 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground transition-colors"
                    title="New Folder" (click)="toggleFolderDropdown()">
                    <lucide-icon [img]="FolderPlus" size="16"></lucide-icon>
                </button>

                <!-- Folder Dropdown Menu -->
                <div *ngIf="folderDropdownOpen()"
                    class="absolute top-full left-0 mt-1 z-[1000] min-w-56 bg-popover border border-border rounded-lg shadow-xl py-1 text-sm">

                    <!-- Entity Folders Header -->
                    <div class="px-3 py-1.5 text-xs font-medium text-muted-foreground uppercase tracking-wide">
                        Entity Folders
                    </div>

                    <!-- Entity Folder Options -->
                    <button *ngFor="let option of entityFolderOptions" class="folder-menu-item"
                        (click)="createEntityFolder(option)">
                        <lucide-icon [img]="option.icon" size="14" [style.color]="option.color"></lucide-icon>
                        <span class="flex-1">{{ option.label }}</span>
                        <span class="text-[10px] font-medium px-1.5 py-0.5 rounded"
                            [style.background-color]="option.color" [style.color]="'white'">
                            {{ option.entityKind }}
                        </span>
                    </button>

                    <!-- Divider -->
                    <div class="h-px bg-border my-1"></div>

                    <!-- Regular Folder -->
                    <button class="folder-menu-item" (click)="createRegularFolder()">
                        <lucide-icon [img]="Folder" size="14" class="text-muted-foreground"></lucide-icon>
                        <span class="flex-1">Regular Folder</span>
                    </button>
                </div>
            </div>

            <!-- Create Narrative Vault Button (Purple/Special) -->
            <button
                class="p-1.5 rounded-md hover:bg-purple-500/20 text-purple-400 hover:text-purple-300 transition-colors"
                title="Create Narrative Vault" (click)="createNarrative()">
                <lucide-icon [img]="BookOpen" size="16"></lucide-icon>
            </button>
        </div>
    </div>

    <!-- Backdrop to close dropdown -->
    <div *ngIf="folderDropdownOpen()" class="fixed inset-0 z-40" (click)="closeFolderDropdown()">
    </div>

    <!-- Sidebar Content -->
    <div class="flex-1 overflow-hidden">
        <app-file-tree [tree]="treeData()"></app-file-tree>
    </div>

    <!-- Sidebar Footer -->
    <div class="h-8 flex items-center px-3 border-t border-border shrink-0">
        <span class="text-xs text-muted-foreground">{{ treeData().length }} items</span>
    </div>
</aside>